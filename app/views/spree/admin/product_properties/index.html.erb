<%= render 'spree/admin/shared/product_sub_menu' %>
<%= render 'spree/admin/shared/product_tabs', :current => 'Product Properties' %>
<%= render 'spree/shared/error_messages', :target => @product %>

<% content_for :page_actions do %>
  <ul class="tollbar inline-menu">
    <li>
      <span id="new_ptype_link">
        <%= link_to Spree.t(:select_from_prototype), available_admin_prototypes_url, :remote => true, 'data-update' => 'prototypes', :class => 'button fa fa-copy' %>
      </span>
    </li>
  </ul>
<% end %>

<%= form_for @product, :url => admin_product_url(@product), :method => :put do |f| %>
  <fieldset class="no-border-top">
    <div class="add_product_properties" data-hook="add_product_properties"></div>

    <div id="prototypes" data-hook></div>
    <%= image_tag 'select2-spinner.gif', :plugin => 'spree', :style => 'display:none;', :id => 'busy_indicator' %>

    <% if @product.product_properties.uncategorized.any? %>
      <h3>Uncategorized</h3>
      <% properties = @product.product_properties.uncategorized %>
      <%= render "category_table", f: f, category: nil, properties: properties %>
    <% end %>

    <% @categories.each do |category| %>
      <%# TODO: Styling & Locales %>
      <h3><%= category.name %> Category</h3>
      <% properties = @product.product_properties.for_category(category) %>
      <%= render "category_table", f: f, category: category, properties: properties %>
    <% end %>

    <%= render 'spree/admin/shared/edit_resource_links' %>

    <%= hidden_field_tag 'clear_product_properties', 'true' %>
  </fieldset>
<% end %>

<%= javascript_tag do -%>
  var properties = <%= raw(@properties.to_json) %>;
  $('#product_properties').on('keydown', 'input.autocomplete', function() {
    already_auto_completed = $(this).is('ac_input');
    if (!already_auto_completed) {
      $(this).autocomplete({source: properties});
      $(this).focus();
    }
  });
<% end -%>
